{
  "discoveryModel": {
    "name": "ob-v3.0-ozone-psu",
    "description": "An Ozone discovery template for v3.0 of Accounts API using Custom tests",
    "discoveryVersion": "v0.2.1",
    "tokenAcquisition": "psu",
    "discoveryItems": [
      {
        "apiSpecification": {
          "name": "Account and Transaction API Specification",
          "url": "https://openbanking.atlassian.net/wiki/spaces/DZ/pages/642090641/Account+and+Transaction+API+Specification+-+v3.0",
          "version": "v3.0",
          "schemaVersion": "https://raw.githubusercontent.com/OpenBankingUK/read-write-api-specs/v3.0.0/dist/account-info-swagger.json"
        },
        "openidConfigurationUri": "https://modelobankauth2018.o3bank.co.uk:4101/.well-known/openid-configuration",
        "resourceBaseUri": "https://modelobank2018.o3bank.co.uk:4501/open-banking/v3.0/aisp",
        "resourceIds": {
          "AccountId": "500000000000000000000001",
          "ConsentId": "$consent_id",
          "fapi_financial_id": "0015800001041RHAAY"
        },
        "endpoints": [
          {
            "method": "POST",
            "path": "/account-access-consents"
          },
          {
            "method": "GET",
            "path": "/account-access-consents/{ConsentId}"
          },
          {
            "method": "DELETE",
            "path": "/account-access-consents/{ConsentId}"
          },
          {
            "method": "GET",
            "path": "/accounts/{AccountId}/product"
          },
          {
            "method": "GET",
            "path": "/accounts/{AccountId}/transactions"
          },
          {
            "method": "GET",
            "path": "/accounts"
          },
          {
            "method": "GET",
            "path": "/accounts/{AccountId}"
          },
          {
            "method": "GET",
            "path": "/accounts/{AccountId}/balances"
          }
        ]
      }
    ],
    "customTests": [
      {
        "name": "CustomTest-GetOzoneToken",
        "description": "Testcase sequence to retrieve an ozone token",
        "replacementParameters": {
          "client_id": "*** REPLACE_ME_WITH_YOUR_OZONE_CLIENT_ID ***",
          "fapi_financial_id": "0015800001041RHAAY",
          "basic_authentication": "*** REPLACE_ME_WITH_YOUR_OZONE_BASIC_AUTH_STRING ***",
          "token_endpoint": "https://modelobank2018.o3bank.co.uk:4201",
          "authorisation_endpoint": "https://modelobankauth2018.o3bank.co.uk:4101",
          "resource_server": "https://modelobank2018.o3bank.co.uk:4501",
          "redirect_url": "*** REPLACE_ME_WITH_YOUR_SOFTWARE_STATEMENT_REDIRECT_URL ***",
          "permission_payload": "{\"Data\": { \"Permissions\": [ \"ReadAccountsBasic\", \"ReadAccountsDetail\", \"ReadBalances\", \"ReadBeneficiariesBasic\", \"ReadBeneficiariesDetail\", \"ReadDirectDebits\", \"ReadTransactionsBasic\", \"ReadTransactionsCredits\", \"ReadTransactionsDebits\", \"ReadTransactionsDetail\", \"ReadProducts\", \"ReadStandingOrdersDetail\"], \"TransactionFromDateTime\": \"2016-01-01T10:40:00+02:00\", \"TransactionToDateTime\": \"2025-12-31T10:40:00+02:00\" },  \"Risk\": {} }"
        },
        "testSequence": [
          {
            "@id": "#ct0001",
            "name": "ClientCredential Grant",
            "input": {
              "method": "POST",
              "endpoint": "/token",
              "headers": {
                "content-type": "application/x-www-form-urlencoded",
                "accept": "*/*",
                "authorization": "Basic $basic_authentication"
              },
              "formData": {
                "grant_type": "client_credentials",
                "scope": "accounts openid"
              }
            },
            "context": {
              "baseurl": "$token_endpoint"
            },
            "expect": {
              "status-code": 200,
              "contextPut": {
                "matches": [
                  {
                    "name": "client_access_token",
                    "description": "Access Token",
                    "json": "access_token"
                  }
                ]
              }
            }
          },
          {
            "@id": "#ct0002",
            "name": "PostAccount Request",
            "input": {
              "method": "POST",
              "endpoint": "/open-banking/v3.0/aisp/account-access-consents",
              "headers": {
                "content-type": "application/json",
                "accept": "*/*",
                "x-fapi-interaction-id": "b4405450-febe-11e8-80a5-0fcebb1574e5",
                "x-fapi-financial-id": "$fapi_financial_id",
                "authorization": "bearer $client_access_token"
              },
              "bodyData": "$permission_payload"
            },
            "context": {
              "baseurl": "$resource_server"
            },
            "expect": {
              "status-code": 201,
              "matches": [
                {
                  "description": "Check we get Status:AwaitingAuthorisation",
                  "json": "Data.Status",
                  "value": "AwaitingAuthorisation"
                }
              ],
              "contextPut": {
                "matches": [
                  {
                    "name": "consent_id",
                    "description": "gets the consentid from PostAccountRequest ",
                    "json": "Data.ConsentId"
                  }
                ]
              }
            }
          },
          {
            "@id": "#ct0003",
            "name": "OpenID Connect Discovery",
            "input": {
              "method": "GET",
              "endpoint": "/.well-known/openid-configuration",
              "headers": {
                "content-type": "application/json; charset=utf-8",
                "accept": "*/*"
              }
            },
            "context": {
              "baseurl": "$authorisation_endpoint"
            },
            "expect": {
              "status-code": 200,
              "contextPut": {
                "matches": [
                  {
                    "name": "authorization_endpoint",
                    "description": "The authorization URL",
                    "json": "authorization_endpoint"
                  }
                ]
              }
            }
          },
          {
            "@id": "#ct0004",
            "name": "Ozone PSU Consent Flow",
            "input": {
              "method": "GET",
              "endpoint": "$authorization_endpoint?",
              "generation": {
                "strategy": "consenturl"
              },
              "claims": {
                "aud": "$baseurl",
                "iss": "$client_id",
                "scope": "openid accounts",
                "redirect_url": "$redirect_url",
                "consentId": "$consent_id",
                "responseType": "code"
              }
            },
            "context": {},
            "expect": {
              "status-code": 302
            }
          }
        ]
      }
    ]
  }
}
